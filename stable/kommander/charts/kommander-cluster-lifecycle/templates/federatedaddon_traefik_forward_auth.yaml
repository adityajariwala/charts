apiVersion: types.kubefed.io/v1beta1
kind: FederatedAddon
metadata:
  name: traefik-forward-auth-kommander
  namespace: kommander-system
spec:
  placement:
    clusterSelector:
      matchLabels: {}
  overrides: []
  template:
    metadata:
      namespace: kommander-system
      labels:
        kubeaddons.mesosphere.io/name: traefik-forward-auth-kommander
    spec:
      namespace: kommander-system
      kubernetes:
        minSupportedVersion: v1.15.0
      cloudProvider:
        - enabled: true
          name: aws
        - enabled: true
          name: azure
        - enabled: true
          name: docker
        - enabled: true
          name: none
      requires:
        - matchLabels:
            kubeaddons.mesosphere.io/name: dex
        - matchLabels:
            kubeaddons.mesosphere.io/provides: ingresscontroller
      chartReference:
        chart: traefik-forward-auth
        repo: https://mesosphere.github.io/charts/staging
        version: 0.2.14
        values: |
          ---
          replicaCount: 1
          image:
            repository: mesosphere/traefik-forward-auth
            tag: 2.0.4
            pullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
          service:
            type: ClusterIP
            port: 4181
          traefikForwardAuth:
            enabled: false
            # oidcUri will be overridden by the init-container
            oidcUri: "https://dex-kubeaddons.kubeaddons.svc.cluster.local:8080/dex"
            clientId: traefik-forward-auth-kommander
            clientSecret:
              value: "placeholder"
              valueFrom:
                secretKeyRef: null
            allowedUser:
              valueFrom:
                secretKeyRef: null
            cookieSecure: true
            userCookieName: "kommander_profile_name"
            whitelist: []
            enableRBAC: true
            enableImpersonation: true
            rbacPassThroughPaths: ["/ops/portal/kubernetes/", "/ops/portal/kubernetes/*"]
            extraConfig: |
              cookie-name =  _forward_auth_kommander
              csrf-cookie-name = _forward_auth_csrf_kommander
              url-path = /_oauth_kommander
              groups-session-name = _forward_auth_claims_kommander
          ingress:
            enabled: true
            annotations:
              kubernetes.io/ingress.class: traefik
              ingress.kubernetes.io/protocol: https
              traefik.ingress.kubernetes.io/auth-type: forward
              traefik.ingress.kubernetes.io/auth-url: http://traefik-forward-auth-kommander-kubeaddons.kommander-system.svc.cluster.local:4181/
              traefik.ingress.kubernetes.io/priority: "3"
            paths:
              - /_oauth_kommander
            hosts:
              - ""
            tls: []
          initContainers: null
